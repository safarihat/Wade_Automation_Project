{% extends 'wade_automation/base.html' %}
{% load static %}
{% block title %}Step 4: Map Farming Activities{% endblock %}

{% block extra_head %}
<!-- Leaflet.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<!-- Leaflet.js Draw Plugin CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

<style>
    h1 {
        font-weight: 600;
    }
    #map {
        position: relative;
        width: 100%;
        height: 75vh; /* Responsive height */
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background-color: #f0f0f0; /* Fallback color */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .sidebar-column {
        background-color: #f8f9fa;
        padding: 24px;
        border-radius: 8px;
        height: 75vh;
        overflow-y: auto;
    }
    .tool-palette {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .palette-title {
        font-weight: bold;
        font-size: 0.9rem;
        margin-bottom: 12px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .tool-palette .btn {
        display: flex;
        align-items: center;
        text-align: left;
        width: 100%;
        justify-content: flex-start;
    }
    .tool-palette .btn .fa-fw {
        margin-right: 10px;
    }
    .tool-palette .btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    /* Custom style for text labels on the map */
    .leaflet-text-label {
        background-color: rgba(255, 255, 255, 0.9);
        border: 1px solid #555;
        border-radius: 4px;
        padding: 4px 8px;
        font-weight: bold;
        text-align: center;
        white-space: nowrap;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        cursor: move; /* Indicates it's draggable */
    }
    .leaflet-text-label:hover {
        background-color: white;
    }
    /* Style for the inline text input on the map */
    .leaflet-text-input {
        background: white;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        padding: 3px 7px;
        font-weight: bold;
        box-shadow: 0 1px 5px rgba(0,0,0,0.6);
        outline: none;
    }
    /* Container for the new map controls */
    .map-controls-container {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000; /* Ensure buttons are on top of the map */
        display: flex;
        gap: 10px;
    }
    /* Box for regulatory info */
    .info-box {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
    }
    /* Class to hide elements from printing */
    @media print {
        .no-print {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h1>Step 4: Map Farming Activities</h1>
            <p class="lead text-muted">Draw your actual and planned farming activities on the map below.</p>
        </div>
    </div>

    <form method="post" id="map-form">
        {% csrf_token %}
        <input type="hidden" name="activity_features" id="id_activity_features">

        <div class="row">
            <!-- Main Canvas Column -->
            <div class="col-lg-9" style="position: relative;">
                <div id="map"></div>
                <!-- New button container positioned over the map -->
                <div class="map-controls-container">
                    <button type="button" id="recenter-map-btn" class="btn btn-lg btn-primary shadow"><i class="fas fa-expand-arrows-alt me-2"></i>Recenter</button>
                    <button type="button" id="add-text-btn" class="btn btn-lg btn-success shadow"><i class="fas fa-font me-2"></i>Add Label</button>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="col-lg-3">
                <div class="sidebar-column">

                    <!-- Drawing Hints -->
                    <div>
                        <div class="palette-title">Drawing Hints</div>
                        <ul class="list-unstyled small text-muted">
                            <li class="mb-2"><i class="fas fa-mouse-pointer fa-fw text-primary me-1"></i>Draw your actual and planned farming activities on the map.</li>
                            <li class="mb-2"><i class="fas fa-book-open fa-fw text-primary me-1"></i>Check the regulatory requirements below for guidance.</li>
                            <li class="mb-2"><i class="fas fa-edit fa-fw text-primary me-1"></i>Use 'Edit layers' to move or delete your drawings.</li>
                            <li class="mb-2"><i class="fas fa-expand-arrows-alt fa-fw text-primary me-1"></i>Hit 'Recenter' if the map moves by accident.</li>
                            <li class="mb-2"><i class="fas fa-desktop fa-fw text-primary me-1"></i>Use fullscreen (hit F11) to give yourself more space.</li>
                            <li class="mt-3 mb-2"><i class="fas fa-draw-polygon fa-fw text-primary me-1"></i>To draw a <strong>zone</strong>, use the 'Draw a polygon' tool. Click to add points, then click your first point to finish. Make sure you add a text label describing the zone or feature</li>
                            <li class="mt-2"><i class="fas fa-wave-square fa-fw text-primary me-1"></i>To trace a <strong>fenceline</strong>, use the 'Draw a polyline' tool. Add points, then click the last point again to finish. Add your text labels</li>
                        </ul>
                    </div>
                    <!-- Instructions -->
                    <div class="mt-4 info-box no-print">
                        <div class="palette-title">Regulatory Requirements - what this map needs to show</div>
                        <div class="small text-muted">
                            <p>The regulatory guidance requires consideration be given to the following areas. Use this as a guide for what to draw and label on your map.</p>
                            
                            <ol class="mt-3" style="padding-left: 1.2em;">
                                <li>
                                    <strong>Features related to farming</strong><br>
                                    To support the risk assessment under regulation 8(1)(b)(ii) and the identification of actions under regulation 8(2), a freshwater farm plan must contain maps that show:
                                    <ol type="a" class="mt-2" style="padding-left: 1.2em;">
                                        <li>fencing to exclude stock from freshwater bodies</li>
                                        <li>planted riparian areas</li>
                                        <li>soil erosion control plantings or works</li>
                                        <li>effluent systems and application areas</li>
                                        <li>water-take bores and surface water abstraction points or intakes, including fish screens</li>
                                        <li>freshwater crossings, including formed crossings, such as bridges, culverts, and fords, and unformed crossings</li>
                                        <li>stock-holding areas, including feedpads, winter pads, stand-off pads, and loafing pads</li>
                                        <li>other stock-related infrastructure, including milking sheds, wintering barns and shelters, and stock yards</li>
                                        <li>farm accessways (for example, formed roads, tracks, races, and under‚Äê passes)</li>
                                        <li>point source discharges, including:
                                            <ul style="padding-left: 1.2em;">
                                                <li>rubbish dumps, offal pits, and silage pits;</li>
                                                <li>feed storage bunkers or sheds; and</li>
                                                <li>agrichemical, fertiliser, and fuel storage sites; and</li>
                                                <li>agrichemical washdown areas</li>
                                            </ul>
                                        </li>
                                        <li>private drinking water supply points</li>
                                    </ol>
                                </li>
                                <li class="mt-3">
                                    <strong>New physical works</strong><br>
                                    A freshwater farm plan must contain maps that show new physical works (if any) to be undertaken on the farm as set out in the action plan. Examples of physical works are set out in subclause (2).
                                </li>
                                <li class="mt-3">
                                    <strong>Factors not considered in risk assessment</strong><br>
                                    When developing a freshwater farm plan, a farm operator does not need to consider the risks of adverse effects of the following on freshwater and freshwater ecosystems: areas of exotic or indigenous forestry, processing facilities or packhouses, residential or commercial premises, and visitor accommodation.
                                </li>
                            </ol>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <a href="{% url 'doc_generator:plan_wizard_map_vulnerabilities' pk=plan.pk %}" class="btn btn-lg btn-outline-secondary"><i class="fas fa-chevron-left me-2"></i>Back</a>
            <button type="submit" class="btn btn-lg btn-gradient">Save and Continue<i class="fas fa-chevron-right ms-2"></i></button>
        </div>
    </form>
</div>

<!-- Leaflet.js -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Leaflet.js Draw Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const mapSnapshotUrl = '{{ map_snapshot_url|safe }}';
    const activityFeaturesJson = '{{ activity_features_json|safe }}';
    const hiddenInput = document.getElementById('id_activity_features');

    if (!mapSnapshotUrl) {
        document.getElementById('map').innerHTML = '<div class="alert alert-danger m-3">Map snapshot not found. Cannot initialize map.</div>';
        return;
    }

    // --- 1. Initialize Map ---
    const map = L.map('map', {
        crs: L.CRS.Simple, // Use a simple coordinate system for the image
        minZoom: -2,
        maxZoom: 4,
        center: [0, 0],
        zoom: 0
    });

    // --- 2. Load Image Snapshot as Map Layer ---
    // This method lets Leaflet handle the image loading and sizing, which is more reliable.
    const imageOverlay = L.imageOverlay(mapSnapshotUrl, [[0, 0], [1, 1]]); // Temporary bounds
    imageOverlay.on('load', function() {
        // Once the image is loaded, get its dimensions and set the correct bounds
        const img = this._image;
        const imgWidth = img.naturalWidth;
        const imgHeight = img.naturalHeight;
        const bounds = [[-imgHeight / 2, -imgWidth / 2], [imgHeight / 2, imgWidth / 2]];
        
        this.setBounds(bounds);
        map.fitBounds(bounds);

        // Now that the map is ready, initialize the drawing tools
        initializeDrawingTools();

        // --- Add event listener for the recenter button ---
        const recenterBtn = document.getElementById('recenter-map-btn');
        if (recenterBtn) {
            recenterBtn.addEventListener('click', () => {
                map.fitBounds(bounds);
            });
        }
    });
    imageOverlay.on('error', function() {
        document.getElementById('map').innerHTML = '<div class="alert alert-danger m-3">Could not load map snapshot image.</div>';
    });
    imageOverlay.addTo(map);


    // --- 3. Function to Initialize Drawing Tools ---
    // This is called only after the map image has successfully loaded.
    function initializeDrawingTools() {
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems,
                remove: true
            },
            draw: {
                polygon: { shapeOptions: { color: '#0d6efd' } },
                polyline: { shapeOptions: { color: '#0d6efd' } },
                rectangle: { shapeOptions: { color: '#0d6efd' } },
                circle: true,
                marker: false, // We use a custom icon placer, so disable the default marker
                circlemarker: false
            }
        });
        map.addControl(drawControl);

        // --- 4. Load Existing Data ---
        if (activityFeaturesJson && activityFeaturesJson !== 'null') {
            try {
                const geoJsonData = JSON.parse(activityFeaturesJson);
                L.geoJSON(geoJsonData, {
                    pointToLayer: function (feature, latlng) {
                        if (feature.properties && feature.properties.isText) {
                            // Recreate text labels
                            return createStaticTextMarker(latlng, feature.properties.label);
                        }
                        // Fallback for standard points
                        return L.marker(latlng);
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.label) {
                            layer.bindPopup(feature.properties.label);
                        } else {
                            // Only bind popups to non-text layers to avoid conflicts
                            layer.bindPopup('A drawn shape.');
                        }
                        drawnItems.addLayer(layer);

                    }
                });
            } catch (e) {
                console.error("Could not parse or load existing GeoJSON data:", e);
            }
        }

        // --- 5. Handle Drawing Events ---
        function updateHiddenInput() {
            const geoJSON = drawnItems.toGeoJSON();
            hiddenInput.value = JSON.stringify(geoJSON);
        }

        map.on(L.Draw.Event.CREATED, function (event) {
            const layer = event.layer;
            drawnItems.addLayer(layer);
            updateHiddenInput();
        });

        map.on('draw:edited', updateHiddenInput);
        map.on('draw:deleted', updateHiddenInput);

        // --- 6. Text Label Placement and Editing Logic ---
        let placingText = false;
        const addTextBtn = document.getElementById('add-text-btn');

        function enterTextMode() {
            addTextBtn.classList.add('active');
            placingText = true;
            L.DomUtil.addClass(map._container, 'leaflet-crosshair');
        }
        function exitPlacingMode() {
            addTextBtn.classList.remove('active');
            L.DomUtil.removeClass(map._container, 'leaflet-crosshair');
            placingText = false;
        }

        addTextBtn.addEventListener('click', function(e) {
            if (placingText) {
                exitPlacingMode();
            } else {
                enterTextMode();
            }
            e.stopPropagation();
        });

        map.on('click', function (e) {
            if (placingText) {
                createEditableTextMarker(e.latlng);
                exitPlacingMode();
            }
        });

        // --- Helper functions for text labels ---

        // Creates a static, draggable text label
        function createStaticTextMarker(latlng, text) {
            const textIcon = L.divIcon({
                className: 'leaflet-text-label',
                html: `<span>${text}</span>`,
            });
            const marker = L.marker(latlng, { icon: textIcon, draggable: true });

            marker.feature = marker.feature || {};
            marker.feature.type = "Feature";
            marker.feature.properties = { label: text, isText: true };

            // Double-click to edit
            marker.on('dblclick', () => {
                drawnItems.removeLayer(marker);
                updateHiddenInput();
                createEditableTextMarker(marker.getLatLng(), marker.feature.properties.label);
            });

            // Update position on drag
            marker.on('dragend', updateHiddenInput);

            return marker;
        }

        // Creates a temporary marker with an input field
        function createEditableTextMarker(latlng, existingText = '') {
            const inputHtml = `<input type="text" class="leaflet-text-input" value="${existingText}" placeholder="Enter text...">`;
            const textInputIcon = L.divIcon({
                className: 'leaflet-text-input-container',
                html: inputHtml,
                iconAnchor: [0, 14] // Position correctly relative to click
            });

            const inputMarker = L.marker(latlng, { icon: textInputIcon }).addTo(map);
            const inputEl = inputMarker.getElement().querySelector('input');
            
            // Auto-focus and select text
            inputEl.focus();
            inputEl.select();

            const saveText = () => {
                const newText = inputEl.value;
                map.removeLayer(inputMarker); // Remove the temporary input marker
                if (newText) {
                    const newStaticMarker = createStaticTextMarker(latlng, newText);
                    drawnItems.addLayer(newStaticMarker);
                    updateHiddenInput();
                }
                // Remove event listeners to prevent memory leaks
                L.DomEvent.off(inputEl, 'keydown', onKeyDown);
                L.DomEvent.off(inputEl, 'blur', saveText);
            };

            const onKeyDown = (e) => { if (e.key === 'Enter') saveText(); };

            L.DomEvent.on(inputEl, 'keydown', onKeyDown);
            L.DomEvent.on(inputEl, 'blur', saveText);
        }
    }

    // --- 7. Form Submission ---
    document.getElementById('map-form').addEventListener('submit', function() {
        // The updateHiddenInput function is called on every draw/edit/delete event,
        // so the data should be up-to-date. No extra action needed here unless
        // there are other form elements to process.
    });
});
</script>
{% endblock %}