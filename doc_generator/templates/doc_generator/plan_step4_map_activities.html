{% extends 'wade_automation/base.html' %}
{% load static %}

{% block title %}Step 4: Map Farming Activities{% endblock %}

{% block extra_head %}
    <!-- MapLibre GL CSS -->
    <link href='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css' rel='stylesheet' />
    <!-- Mapbox GL Draw CSS (compatible with MapLibre) -->
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.0/mapbox-gl-draw.css' type='text/css' />
    <style>
        .map-container-wrapper {
            position: relative;
            padding-top: 75%; /* 4:3 ratio */
        }
        #map { position: absolute; top: 0; left: 0; height: 100%; width: 100%; border-radius: 8px; }
        .sidebar {
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            min-height: 300px;
        }
        .map-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
            font-family: sans-serif;
            z-index: 1;
        }
        /* Simple legend styles */
        .legend {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            line-height: 1.5;
            font-size: 0.85rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-key {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
    </style>
{% endblock %}

{% block content %}
<main class="page-section">
    <div class="container-fluid">
        <h1 class="text-center">Step 4: Map Farming Activities & Infrastructure</h1>
        <p class="lead text-center">Use the map tools to draw the key operational areas and infrastructure on your farm. This information is crucial for identifying where activities might interact with environmental vulnerabilities.</p>

        <div class="row justify-content-center mt-4">
            <div class="col-lg-8 col-xl-9">
                <div class="map-container-wrapper mb-4">
                    <div id="map"></div>
                    <div id="map-overlay" class="map-overlay">
                        <input id="aerial-layer" type="radio" name="rtoggle" value="aerial" checked="checked"><label for="aerial-layer">Aerial</label>
                        <input id="topo-layer" type="radio" name="rtoggle" value="topo"><label for="topo-layer">Topo</label>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-xl-3">
                <div class="sidebar">
                    <h5>Instructions</h5>
                    <p class="small">Use the drawing tools on the map to outline features. You can draw points, lines, or polygons.</p>
                    <p class="small">After drawing a feature, you can categorize it and add a description in the popup that appears.</p>
                    <hr>
                    <div id="legend" class="legend">
                        <h5>Legend</h5>
                        <!-- Legend items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <form method="post" class="mt-3">
            {% csrf_token %}
            <input type="hidden" name="activity_features" id="id_activity_features">
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'doc_generator:plan_wizard_map_vulnerabilities' pk=plan.pk %}" class="btn btn-lg btn-outline-secondary"><i class="fas fa-chevron-left me-2"></i>Back to Vulnerabilities</a>
                <button type="submit" class="btn btn-lg btn-gradient ms-3">Save & Continue<i class="fas fa-chevron-right ms-2"></i></button>
            </div>
        </form>
    </div>

    <!-- Data container for JS -->
    <div id="map-data"
         data-plan-pk="{{ plan.pk }}"
         data-lat="{{ plan.latitude|default:'' }}"
         data-lon="{{ plan.longitude|default:'' }}"
         data-linz-basemaps-key="{{ LINZ_BASEMAPS_API_KEY|safe }}"
         data-existing-features="{{ activity_features_json|escapejs }}"
         style="display:none;"></div>
</main>
{% endblock %}

{% block extra_js %}
<!-- MapLibre GL JS -->
<script src='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js'></script>
<!-- Mapbox GL Draw (works with MapLibre) -->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.0/mapbox-gl-draw.js'></script>
<!-- Turf.js for geospatial computations -->
<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const dataEl = document.getElementById('map-data');
    const lat = parseFloat(dataEl.dataset.lat);
    const lon = parseFloat(dataEl.dataset.lon);
    const linzBasemapsKey = dataEl.dataset.linzBasemapsKey;
    const existingFeatures = JSON.parse(dataEl.dataset.existingFeatures || 'null');
    const hiddenInput = document.getElementById('id_activity_features');

    // Define categories for farming activities
    const activityTypes = {
        'paddock': { color: '#2ca02c', name: 'Paddock / Block' },
        'winter_grazing': { color: '#a52a2a', name: 'Winter Grazing Area' },
        'cropping': { color: '#ff7f0e', name: 'Cropping Area' },
        'farm_track': { color: '#8c564b', name: 'Farm Track / Race' },
        'stock_crossing': { color: '#1f77b4', name: 'Stock Crossing' },
        'effluent_pond': { color: '#9467bd', name: 'Effluent Pond / System' },
        'silage_pit': { color: '#d62728', name: 'Silage Pit' },
        'water_trough': { color: '#17becf', name: 'Water Trough' },
        'uncategorized': { color: '#7f7f7f', name: 'Uncategorized' }
    };

    // --- Map Initialization ---
    const aerialTileUrl = `https://basemaps.linz.govt.nz/v1/tiles/aerial/WebMercatorQuad/{z}/{x}/{y}.png?api=${linzBasemapsKey}`;
    const topoTileUrl = `https://basemaps.linz.govt.nz/v1/tiles/topographic/WebMercatorQuad/{z}/{x}/{y}.png?api=${linzBasemapsKey}`;

    const map = new maplibregl.Map({
        container: 'map',
        style: {
            "version": 8,
            "sources": {
                "linz-aerial": { "type": "raster", "tiles": [aerialTileUrl], "tileSize": 256, "attribution": "© LINZ" },
                "linz-topo": { "type": "raster", "tiles": [topoTileUrl], "tileSize": 256, "attribution": "© LINZ" }
            },
            "layers": [
                { "id": "linz-aerial-layer", "type": "raster", "source": "linz-aerial" },
                { "id": "linz-topo-layer", "type": "raster", "source": "linz-topo", "layout": { "visibility": "none" } }
            ]
        },
        center: [lon, lat],
        zoom: 14
    });

    // --- Layer switcher logic ---
    document.getElementById('map-overlay').addEventListener('change', (event) => {
        if (event.target.name === 'rtoggle') {
            const layerId = event.target.value;
            map.setLayoutProperty('linz-aerial-layer', 'visibility', layerId === 'aerial' ? 'visible' : 'none');
            map.setLayoutProperty('linz-topo-layer', 'visibility', layerId === 'topo' ? 'visible' : 'none');
        }
    });

    // --- Drawing Controls ---
    const draw = new MapboxDraw({
        displayControlsDefault: false,
        controls: { point: true, line_string: true, polygon: true, trash: true },
        styles: [
            { id: 'gl-draw-polygon-fill', type: 'fill', paint: { 'fill-color': ['get', 'color'], 'fill-opacity': 0.4 }},
            { id: 'gl-draw-polygon-stroke', type: 'line', paint: { 'line-color': ['get', 'color'], 'line-width': 3 }},
            { id: 'gl-draw-line', type: 'line', paint: { 'line-color': ['get', 'color'], 'line-width': 3 }},
            { id: 'gl-draw-point', type: 'circle', paint: { 'circle-radius': 5, 'circle-color': ['get', 'color'] }}
        ]
    });
    map.addControl(draw);

    // --- Form & Feature Logic ---
    function updateForm() {
        const data = draw.getAll();
        hiddenInput.value = data.features.length ? JSON.stringify(data) : '';
    }

    function applyDefaultProperties(feature) {
        const defaultType = 'uncategorized';
        draw.setFeatureProperty(feature.id, 'activity_type', defaultType);
        draw.setFeatureProperty(feature.id, 'description', '');
        draw.setFeatureProperty(feature.id, 'color', activityTypes[defaultType].color);
    }

    // --- Parcel Boundary & Initial View ---
    async function fetchAndDrawParcel() {
        const parcelApiUrl = `{% url 'doc_generator:api_get_parcel_geometry' %}?lat=${lat}&lon=${lon}`;
        try {
            const response = await fetch(parcelApiUrl);
            const geojsonData = await response.json();
            if (geojsonData && geojsonData.features && geojsonData.features.length > 0) {
                map.addSource('parcel-boundary', { 'type': 'geojson', 'data': geojsonData });
                map.addLayer({
                    'id': 'parcel-boundary-layer',
                    'type': 'line',
                    'source': 'parcel-boundary',
                    'paint': { 'line-color': '#FF0000', 'line-width': 2.5 }
                });
                return geojsonData;
            }
        } catch (error) {
            console.error("Failed to fetch parcel geometry:", error);
        }
        return null;
    }

    map.on('load', async () => {
        const parcelData = await fetchAndDrawParcel();

        if (existingFeatures && existingFeatures.features && existingFeatures.features.length > 0) {
            for (const f of existingFeatures.features) {
                const t = (f.properties && f.properties.activity_type) || 'uncategorized';
                const color = (activityTypes[t] || activityTypes['uncategorized']).color;
                if (!f.properties) f.properties = {};
                f.properties.color = color;
            }
            draw.set(existingFeatures);
            const bbox = turf.bbox(existingFeatures);
            map.fitBounds(bbox, { padding: 50, duration: 0 });
        } else if (parcelData) {
            const bbox = turf.bbox(parcelData);
            map.fitBounds(bbox, { padding: 50, duration: 0 });
        }

        updateForm();
    });

    // --- Popup for Editing Feature Properties ---
    let popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });

    function createPopupContent(feature) {
        const currentType = feature.properties.activity_type || 'uncategorized';
        const currentDesc = feature.properties.description || '';

        const typeOptions = Object.keys(activityTypes).map(key =>
            `<option value="${key}" ${key === currentType ? 'selected' : ''}>${activityTypes[key].name}</option>`
        ).join('');

        return `
            <div>
                <label for="popup-type" class="form-label form-label-sm">Activity Type</label>
                <select id="popup-type" class="form-select form-select-sm mb-2">${typeOptions}</select>
                <label for="popup-desc" class="form-label form-label-sm">Description</label>
                <textarea id="popup-desc" class="form-control form-control-sm" rows="2">${currentDesc}</textarea>
                <button id="popup-save" class="btn btn-sm btn-primary mt-2">Save</button>
            </div>
        `;
    }

    function showPopup(feature) {
        const coordinates = turf.centerOfMass(feature).geometry.coordinates;
        popup.setLngLat(coordinates).setHTML(createPopupContent(feature)).addTo(map);

        document.getElementById('popup-save').addEventListener('click', () => {
            const newType = document.getElementById('popup-type').value;
            const newDesc = document.getElementById('popup-desc').value;
            draw.setFeatureProperty(feature.id, 'activity_type', newType);
            draw.setFeatureProperty(feature.id, 'description', newDesc);
            draw.setFeatureProperty(feature.id, 'color', activityTypes[newType].color);
            popup.remove();
            updateForm();
        });
    }

    map.on('draw.create', (e) => {
        const feature = e.features[0];
        applyDefaultProperties(feature);
        updateForm();
        showPopup(feature);
    });

    map.on('draw.update', (e) => {
        updateForm();
        if (e.features.length > 0) {
            showPopup(e.features[0]);
        }
    });

    map.on('click', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['gl-draw-polygon-fill', 'gl-draw-line', 'gl-draw-point'] });
        if (features.length > 0) {
            const featureId = features[0].properties.id;
            const feature = draw.get(featureId);
            if (feature) {
                showPopup(feature);
            }
        }
    });

    map.on('draw.delete', updateForm);

    // --- Populate Legend ---
    const legendEl = document.getElementById('legend');
    for (const key in activityTypes) {
        const item = activityTypes[key];
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.innerHTML = `<span class="legend-key" style="background-color: ${item.color};"></span> ${item.name}`;
        legendEl.appendChild(legendItem);
    }
});
</script>
{% endblock %}